
AWSTemplateFormatVersion: "2010-09-09"
Description: Deploys the AWS Lambda functions required to enable logging of Amazon Connect Contact Trace Records to CloudWatch, S3, or both.
Parameters:
  AWSRegion:
    Type: String
    Default: us-east-1
    AllowedValues:
      - us-east-1
      - us-west-2
      - ap-southeast-1
      - ap-southeast-2
      - ap-northeast-1
      - eu-central-1
      - eu-west-2
    Description: The region code that you are deploying to. This should be the same region that your Amazon Connect instance is deployed to. MAKE SURE that you have your console currently set to this region.

  ConnectInstanceName:
    Type: String
    Default: REPLACEME
    Description: Provide the instance name for Amazon Connect.

  CTRKinesisStreamARN:
    Type: String
    Default: REPLACEME
    Description: Provide the ARN of the Kinesis stream used for CTRs

  Format:
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
    Description: Pretty print CTR output

  LambdaLoggingLevel:
    Type: String
    Default: INFO
    AllowedValues:
      - DEBUG
      - INFO

  S3BucketARN:
    Type: String
    Default: REPLACEME
    Description: ARN of your S3 bucket for storing CTRs

  WriteTo:
    Type: String
    Default: both
    AlloweValues:
      - console
      - s3
      - both

Resources:
  awsscv_ctr_logger:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          !Join
          - ''
          - - 'awsscv-supporting-code-'
            - !Ref AWSRegion
        S3Key: awsscv_ctr_logger.zip
      Description:
      Environment:
        Variables:
          format:
            Ref: Format
          lambda_logging_level:
            Ref: LambdaLoggingLevel
          s3Bucket:
            Ref: S3Bucket
          writeTo:
            Ref: WriteTo
      FunctionName:
        !Join
        - ''
        - - 'awsscv_ctr_logger'
          - !Ref ConnectInstanceName
      Handler: awsscv_ctr_logger.lambda_handler
      Role: !Ref AWSSCVCommonRole
      Runtime: python3.8
      Timeout: 8
